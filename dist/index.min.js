!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("core-js/modules/es6.object.to-string.js"),require("core-js/modules/es6.date.to-string.js"),require("core-js/modules/es6.regexp.to-string.js"),require("core-js/modules/es6.promise.js"),require("axios"),require("crypto-js")):"function"==typeof define&&define.amd?define(["core-js/modules/es6.object.to-string.js","core-js/modules/es6.date.to-string.js","core-js/modules/es6.regexp.to-string.js","core-js/modules/es6.promise.js","axios","crypto-js"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).Socket=t(null,null,null,null,e.axios,e.CryptoJS)}(this,(function(e,t,o,n,i,s){"use strict";function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=r(i),a=r(s);function u(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function l(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function h(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}var f=function(){function e(t,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),h(this,"socketUrl",void 0),h(this,"option",void 0),h(this,"websocket",void 0),h(this,"refreshTimes",void 0),h(this,"times",void 0),h(this,"location",0),h(this,"showWaiting",void 0),h(this,"showIframe",void 0),h(this,"sum",0),h(this,"resource",void 0),h(this,"activeLink",void 0),this.socketUrl=t,this.option=function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?u(Object(o),!0).forEach((function(t){h(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):u(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}({onOpenAutoSendMsg:{messageType:"QUEUE_LOCATION"},openCallback:null,closeCallback:null,messageCallback:null,errorCallback:null,timesSeconds:1e3,refreshSeconds:1e4,socketToken:"",Authorization:"",AuthorizationKey:""},o),this.websocket=null,this.refreshTimes=null,this.times=null,this.location=0,this.showIframe=!1,this.showWaiting=!1,this.sum=0,this.resource="",this.activeLink=!0}var t,o,n;return t=e,(o=[{key:"decryptDES",value:function(e,t){var o=a.default.enc.Utf8.parse(t);return e?a.default.DES.decrypt(e,o,{mode:a.default.mode.ECB,padding:a.default.pad.Pkcs7}).toString(a.default.enc.Utf8):""}},{key:"tryLock",value:function(){var e=this;return new Promise((function(t,o){c.default.get("http://".concat(e.socketUrl,"/resource/try-lock"),{headers:{Authorization:e.option.Authorization,AuthorizationKey:e.option.AuthorizationKey}}).then((function(o){if(301!==o.data.code)throw e.resetWsInfo(),t(o.data),new Error("".concat(o.data.msg));console.log(o.data.data.socketToken),e.option.socketToken=o.data.data.socketToken,e.initWebpack(o.data.data.socketToken),t(o.data)})).catch((function(e){o(e)}))}))}},{key:"initWebpack",value:function(e){if(!("WebSocket"in window))throw new Error("当前浏览器不支持");if(!this.socketUrl)throw new Error("请配置连接地址");this.websocket=null,console.log("socketToken",e);var t="ws://".concat(this.socketUrl,"/resource/ws?Socket-Token=").concat(e,"&Authorization=").concat(this.option.Authorization);this.websocket=new window.WebSocket(t),this.websocketOnOpen(null),this.websocketOnMessage(null),this.websocketOnError(null),this.websocketOnClose(null)}},{key:"websocketOnOpen",value:function(e){var t=this;this.websocket instanceof window.WebSocket&&(this.websocket.onopen=function(o){t.send(JSON.stringify(t.option.onOpenAutoSendMsg)),"function"==typeof e?e(o):"function"==typeof t.option.openCallback&&t.option.openCallback(o)})}},{key:"createSetInterval",value:function(e){var t=this;this.stopSetInterval(),this.refreshTimes=setInterval((function(){c.default.get("http://".concat(t.socketUrl,"/resource/refresh-token/").concat(e),{headers:{Authorization:t.option.Authorization,AuthorizationKey:t.option.AuthorizationKey}}).then((function(e){console.log(e)}))}),this.option.refreshSeconds)}},{key:"stopSetInterval",value:function(){this.refreshTimes&&(clearInterval(this.refreshTimes),this.refreshTimes=null)}},{key:"resetWsInfo",value:function(){this.websocket=null,this.option.socketToken="",this.showIframe=!1,this.showWaiting=!1,this.location=0,this.sum=0}},{key:"send",value:function(e){this.websocket instanceof window.WebSocket&&this.websocket.readyState===this.websocket.OPEN&&this.websocket.send(e)}},{key:"websocketOnMessage",value:function(e){var t=this;this.websocket instanceof window.WebSocket&&(this.websocket.onmessage=function(o){var n=JSON.parse(o.data);if(console.log(n),t.times=null,n.data.location){t.showWaiting=!0,t.showIframe=!0;var i=t;t.location=n.data.location,t.sum=n.data.sum,t.times=setTimeout((function(){t.send(JSON.stringify({messageType:"QUEUE_LOCATION"}))}),i.option.timesSeconds)}else{if(n.data.resource){var s=n.socketToken.substring(0,8);t.resource=t.decryptDES(n.data.resource,s),t.showIframe=!0,clearInterval(t.times),c.default.get("http://".concat(t.socketUrl,"/resource/confirm/").concat(n.socketToken),{headers:{Authorization:t.option.Authorization,AuthorizationKey:t.option.AuthorizationKey}}).then((function(e){console.log(e),t.createSetInterval(n.socketToken)}))}t.showIframe=!0,clearInterval(t.times)}"function"==typeof e?e(o.data):"function"==typeof t.option.messageCallback&&t.option.messageCallback({data:o.data,showIframe:t.showIframe,showWaiting:t.showWaiting})})}},{key:"websocketOnError",value:function(e){var t=this;this.websocket instanceof window.WebSocket&&(this.websocket.onerror=function(o){"function"==typeof e?e(o):"function"==typeof t.option.errorCallback&&t.option.errorCallback(o)})}},{key:"websocketOnClose",value:function(e){var t=this;this.websocket instanceof window.WebSocket&&(this.websocket.onclose=function(o){t.resetWsInfo(),t.stopSetInterval(),"function"==typeof e?e(o):"function"==typeof t.option.closeCallback&&t.option.closeCallback(o)})}},{key:"removeSocket",value:function(){this.activeLink=!1,this.websocket instanceof window.WebSocket&&this.websocket.close(1e3)}},{key:"returnSource",value:function(){this.activeLink=!1,c.default.get("http://".concat(this.socketUrl,"/resource/return/").concat(this.option.socketToken),{headers:{Authorization:this.option.Authorization,AuthorizationKey:this.option.AuthorizationKey}}).then((function(e){console.log(e)})),this.websocket instanceof window.WebSocket&&this.websocket.close(1e3)}},{key:"getWebsocket",value:function(){return this.websocket}},{key:"getActiveLink",value:function(){return this.activeLink}}])&&l(t.prototype,o),n&&l(t,n),Object.defineProperty(t,"prototype",{writable:!1}),e}();return f}));
